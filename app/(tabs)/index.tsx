import { Buffer } from 'buffer';
import * as Location from 'expo-location';
import { transit_realtime } from 'gtfs-realtime-bindings';
import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import {
  ActivityIndicator,
  Pressable,
  ScrollView,
  StyleSheet,
  Text,
  TextInput,
  View,
} from 'react-native';
import { WebView } from 'react-native-webview';

import { useSettings } from '@/context/settings-context';
import { fetchRussianTracks } from '@/services/russian-tracker-service';

// SURPRISE_FEATURE: Import the surprise feature (remove this import to disable)
import {
  SURPRISE_CONFIG,
  SURPRISE_ENABLED,
  SURPRISE_MESSAGE_HANDLERS,
  SURPRISE_SCRIPTS,
  SURPRISE_STYLES,
  getSurprisePayload,
  isSurpriseTrigger,
} from '@/components/surprise-feature';

const globalAny = globalThis as any;
if (!globalAny.Buffer) globalAny.Buffer = Buffer;
if (!globalAny.navigator) globalAny.navigator = { product: 'ReactNative' };

const ADSB_BASE_URL = 'https://api.adsb.one/v2/point';
const DIGITRANSIT_GRAPHQL_URL = 'https://api.digitransit.fi/routing/v2/hsl/gtfs/v1';
const DIGITRANSIT_API_KEY = '0be70031df3a4a0fb77b8c6b487ba826';
const NM_PER_KM = 1 / 1.852;
const POLL_MS = 5000;
const DEMO_COORDS = { latitude: 60.1699, longitude: 24.9384 };
const USE_DEMO_LOCATION = true;

type Aircraft = {
  hex?: string;
  flight?: string;
  lat?: number;
  lon?: number;
  alt_baro?: number;
  gs?: number;
  track?: number;
  military?: boolean;
  desc?: string;
  category?: string;
  type?: string;
  t?: string;
  r?: string;
  [key: string]: unknown;
};

function buildMapHtml() {
  return `<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <style>
      html,
      body,
      #map {
        height: 100%;
        width: 100%;
        margin: 0;
        background: #0e1116;
      }
      .leaflet-container {
        background: #0e1116;
      }
      .aircraft-dot {
        fill: #f7c948;
        stroke: #1c1f24;
        stroke-width: 1;
      }
      .aircraft-icon {
        width: var(--aircraft-size, 26px);
        height: var(--aircraft-size, 26px);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
      }
      .aircraft-icon .material-icons {
        font-size: var(--aircraft-size, 26px);
        line-height: 1;
        color: #f7c948;
        display: block;
        transform-origin: 50% 50%;
        text-shadow:
          -1px 0 0 #0e1116,
          1px 0 0 #0e1116,
          0 -1px 0 #0e1116,
          0 1px 0 #0e1116;
      }
      .aircraft-icon.low-alt .material-icons {
        color: #a66cff;
        text-shadow:
          -1px 0 0 #0e1116,
          1px 0 0 #0e1116,
          0 -1px 0 #0e1116,
          0 1px 0 #0e1116;
      }
      .aircraft-icon.alt-ok .material-icons {
        color: #f2994a;
        text-shadow:
          -1px 0 0 #0e1116,
          1px 0 0 #0e1116,
          0 -1px 0 #0e1116,
          0 1px 0 #0e1116;
      }
      .aircraft-icon.no-speed .material-icons {
        color: #9aa4b2;
        text-shadow:
          -1px 0 0 #0e1116,
          1px 0 0 #0e1116,
          0 -1px 0 #0e1116,
          0 1px 0 #0e1116;
      }
      .aircraft-icon.russian .material-icons {
        color: #ff4444 !important;
        text-shadow:
          -1px 0 0 #0e1116,
          1px 0 0 #0e1116,
          0 -1px 0 #0e1116,
          0 1px 0 #0e1116;
      }
      .bus-dot {
        stroke: #0e1116;
        stroke-width: 1.5;
      }
      .leaflet-top.leaflet-right {
        top: 74px;
        right: 10px !important;
      }
      .leaflet-control-layers {
        border-radius: 4px;
        margin: 0 !important;
        z-index: 800;
        padding: 0 !important;
        border: 1px solid rgba(0, 0, 0, 0.2) !important;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65) !important;
      }
      .leaflet-control-layers-toggle {
        width: 35px !important;
        height: 35px !important;
        background-size: 15px 15px !important;
        border: none !important;
      }
      .me-dot {
        fill: #4fd1c5;
        stroke: #0e1116;
        stroke-width: 2;
      }
      .recenter-control {
        position: absolute;
        top: 130px;
        right: 10px !important;
        width: 35px;
        height: 35px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        z-index: 700;
      }
      .vehicle-tooltip {
        background: rgba(15, 17, 22, 0.92);
        color: #f5f7fb;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 12px;
        line-height: 1.35;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      }
      .vehicle-tooltip .line-text {
        color: #f7c948;
        font-weight: 700;
      }
      .vehicle-tooltip.leaflet-tooltip-top:before {
        border-top-color: rgba(15, 17, 22, 0.92);
      }
      .vehicle-tooltip.leaflet-tooltip-bottom:before {
        border-bottom-color: rgba(15, 17, 22, 0.92);
      }
      .fir-tooltip {
        background: rgba(15, 17, 22, 0.92);
        color: #f5f7fb;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .russian-track-tooltip {
        background: rgba(255, 68, 68, 0.92);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      /* SURPRISE_FEATURE: Styles injected from component */
      ${SURPRISE_ENABLED ? SURPRISE_STYLES : ''}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map('map', { zoomControl: true }).setView([0, 0], 2);
      map.zoomControl.setPosition('bottomright');
      const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      });
      const esriSat = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        {
          maxZoom: 19,
          attribution: 'Tiles &copy; Esri'
        }
      );
      const esriOcean = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',
        {
          maxZoom: 13,
          attribution:
            'Tiles &copy; Esri — Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri'
        }
      );
      const gebcoGlobal = L.tileLayer(
        'https://tiles.arcgis.com/tiles/C8EMgrsFcRFL6LrL/arcgis/rest/services/GEBCO_basemap_NCEI/MapServer/tile/{z}/{y}/{x}',
        {
          maxZoom: 13,
          attribution: 'GEBCO 2024 / NOAA NCEI'
        }
      );
      const cartoLight = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        {
          maxZoom: 20,
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }
      );
      const cartoDark = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        {
          maxZoom: 20,
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }
      );

      esriSat.addTo(map);

      const baseLayers = {
        'Streets (OSM)': osm,
        'Satellite (Esri)': esriSat,
        'Light (CARTO)': cartoLight,
        'Dark (CARTO)': cartoDark
      };

      L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

      // FIR Airspace boundaries (from official Eurocontrol GeoJSON data)
      // Source: https://gist.github.com/LC43/5d6a009d83172d308a01a1c864b71e68
      const firBoundaries = {
        // EFIN FIR - Finland
        EFIN: {
          name: 'EFIN FIR (Finland)',
          color: '#3fa9f5',
          coords: [
            [60.191667, 19.086667], [60.300833, 19.132222], [61.000000, 19.318056], [61.666667, 19.500000],
            [63.166667, 20.166667], [63.475000, 20.666667], [63.616667, 21.500000], [64.683333, 22.916667],
            [65.530000, 24.140000], [66.090278, 23.935833], [66.159358, 23.907494], [66.196403, 23.754808],
            [66.436503, 23.639358], [66.809692, 24.008042], [67.167786, 23.587222], [67.291267, 23.751083],
            [67.424353, 23.765978], [67.468258, 23.441983], [67.867514, 23.497842], [67.945719, 23.654256],
            [68.147406, 23.304192], [68.122708, 23.158950], [68.239331, 23.147778], [68.379275, 22.827508],
            [68.471200, 22.134828], [68.765556, 21.379722], [69.022228, 22.094528], [68.783372, 22.498583],
            [68.700042, 23.281961], [68.766714, 23.631975], [68.866719, 23.731975], [68.816719, 24.215336],
            [68.766719, 24.298678], [68.650053, 24.915381], [68.833394, 25.132050], [69.016739, 25.565394],
            [69.693889, 25.952778], [69.695556, 29.133333], [69.216772, 28.982233], [69.051944, 28.928611],
            [68.916667, 28.450000], [68.883333, 28.533333], [68.866667, 28.800000], [68.550000, 28.450000],
            [68.200000, 28.666667], [68.066667, 29.350000], [67.800000, 29.683333], [67.666667, 30.016667],
            [67.516667, 29.950000], [66.966667, 29.016667], [66.167222, 29.863333], [65.716667, 30.116667],
            [65.666617, 29.832425], [65.216597, 29.615764], [65.199931, 29.915781], [65.083333, 29.583333],
            [64.783244, 29.665781], [64.783333, 30.000000], [64.333333, 30.083333], [64.133222, 30.499172],
            [63.816667, 30.216667], [63.733333, 30.016667], [63.449858, 30.499192], [63.216667, 31.233333],
            [62.900000, 31.583333], [62.500000, 31.200000], [61.433333, 29.450000], [61.249758, 29.115861],
            [60.549722, 27.815828], [60.216667, 27.466667], [60.205000, 27.300000], [60.133333, 26.550000],
            [59.975000, 26.111667], [59.883333, 25.866667], [59.908333, 25.333333], [59.883333, 24.850000],
            [59.000000, 21.000000], [59.256667, 20.544167], [59.562778, 19.983056], [60.191667, 19.086667]
          ]
        },
        // ENOR FIR - Norway
        ENOR: {
          name: 'ENOR FIR (Norway)',
          color: '#ff6b6b',
          coords: [
            [62, 12.219722], [61.5663, 12.565222], [61.366294, 12.865242], [61.199622, 12.781914],
            [61.049614, 12.681917], [60.62366, 12.50333], [60.466258, 12.631942], [60.399589, 12.615278],
            [60.282914, 12.531944], [60.149578, 12.548617], [59.982903, 12.398619], [59.893439, 12.173225],
            [59.904017, 11.973433], [59.841661, 11.849122], [59.745611, 11.97815], [59.685253, 11.945786],
            [59.630386, 11.676075], [59.227097, 11.843294], [58.946686, 11.730014], [58.866667, 11.533333],
            [58.9, 11.433333], [59.022872, 11.384786], [59.083333, 11.333333], [59.023917, 11.153697],
            [58.983333, 11.116667], [58.892222, 10.638889], [58.761111, 10.592222], [58.5, 10.5],
            [57, 7.5], [57, 6], [57, 5], [57.333333, 4.499444], [57.624444, 4.052222], [58.277778, 3.013056],
            [58.39, 2.828889], [58.528889, 2.599444], [59.085, 1.655], [60, 0], [63.25, 0],
            [63.054444, 4.053333], [64, 5.014722], [64.513611, 5.566111], [65.133333, 6.266667],
            [65.618333, 6.840556], [65.75, 7], [66.211111, 7.707778], [67.25, 9.4225], [70, 15],
            [70.365556, 17.254722], [70.475556, 17.988056], [70.666667, 19.506944], [71.333333, 25],
            [71.333333, 26.35], [71.333333, 28], [71.166667, 29], [71, 30], [70.366667, 31.716667],
            [69.794722, 30.817778], [69.683472, 30.932319], [69.583469, 30.932322], [69.550133, 30.848986],
            [69.533464, 30.515636], [69.6668, 30.148942], [69.650133, 30.098939], [69.633467, 30.148944],
            [69.550128, 30.19895], [69.483458, 30.132283], [69.416789, 29.982278], [69.416786, 29.848939],
            [69.316781, 29.532258], [69.333447, 29.498922], [69.300111, 29.282244], [69.233442, 29.332253],
            [69.066767, 29.198919], [69.016764, 29.048914], [69.051944, 28.929444], [69.216772, 28.982233],
            [69.695556, 29.133333], [69.693889, 25.952778], [69.016739, 25.565394], [68.833394, 25.13205],
            [68.650053, 24.915381], [68.766719, 24.298678], [68.816719, 24.215336], [68.866719, 23.731975],
            [68.766714, 23.631975], [68.700042, 23.281961], [68.783372, 22.498583], [69.022228, 22.094528],
            [68.765556, 21.379722], [69.06, 20.548611], [69.04575, 20.060056], [68.95425, 20.241917],
            [68.926194, 20.306583], [68.802306, 20.335861], [68.665898, 20.202769], [68.591103, 20.052289],
            [68.55792, 19.937504], [68.5308, 20.02597], [68.4908, 20.226374], [68.442736, 20.10821],
            [68.390192, 19.981486], [68.35602, 19.921395], [68.514167, 19], [68.506907, 18.621208],
            [68.53368, 18.549924], [68.557036, 18.483766], [68.581906, 18.405757], [68.536441, 18.125917],
            [68.406005, 18.101059], [68.198784, 18.151349], [67.969344, 17.899808], [68.037923, 17.66691],
            [68.075946, 17.490404], [66.153566, 15.035548], [66.132598, 14.516181], [66.041075, 14.545519],
            [66.011966, 14.554413], [65.958201, 14.573086], [65.901312, 14.584484], [65.811825, 14.62544],
            [65.75, 14.578333], [65.700521, 14.541369], [65.515583, 14.498917], [65.309722, 14.506833],
            [65.247611, 14.378806], [65.118917, 14.325972], [64.951111, 14.093611], [64.8425, 13.956667],
            [64.709134, 13.791562], [64.639835, 13.705414], [64.580298, 13.654268], [64.555556, 13.734167],
            [64.079722, 13.376111], [64.095417, 13.211039], [64.057946, 12.926673], [63.974225, 12.68349],
            [63.89237, 12.577269], [63.807023, 12.463467], [63.714944, 12.330381], [63.672038, 12.299497],
            [63.631184, 12.227851], [63.593889, 12.150278], [63.478562, 12.212914], [63.440833, 12.1725],
            [63.269167, 11.974444], [63.185181, 12.050894], [63.141111, 12.090833], [63.000298, 12.218361],
            [62.902556, 12.074694], [62.747917, 12.136389], [62.651389, 12.079444], [62.611917, 12.056139],
            [62.266389, 12.298889], [62, 12.219722]
          ]
        },
        // EKDK FIR - Denmark
        EKDK: {
          name: 'EKDK FIR (Denmark)',
          color: '#4ecdc4',
          coords: [
            [58.5, 10.5], [56.214722, 12.368056], [56.164167, 12.44], [56.058611, 12.640556],
            [56.032778, 12.656944], [55.981111, 12.651944], [55.931269, 12.641142], [55.891389, 12.678333],
            [55.869886, 12.694986], [55.830475, 12.708728], [55.641111, 12.898889], [55.604897, 12.879778],
            [55.549197, 12.741236], [55.495758, 12.714764], [55.419022, 12.606892], [55.336667, 12.640833],
            [54.916667, 12.85], [54.45, 12], [54.445833, 11.833333], [54.463889, 11.666667],
            [54.5, 11.5], [54.554167, 11.333333], [54.602778, 11.166667], [54.644444, 11],
            [54.652778, 10.833333], [54.655556, 10.666667], [54.658333, 10.5], [54.7, 10.333333],
            [54.743056, 10.166667], [54.765, 10.053611], [54.766667, 10], [54.8, 9.65],
            [54.916667, 8.6], [55.069167, 8.391944], [55.066667, 8.333333], [55, 8], [55, 6.5],
            [55, 5], [54.5, 4.535833], [54.645278, 4.333333], [54.824167, 4.186111], [55.047778, 4],
            [55.644444, 3.632222], [55.854444, 3.5], [56.509722, 3.5], [57.333333, 4.499444],
            [57, 5], [57, 7.5], [58.5, 10.5]
          ]
        },
        // ESMM FIR - Sweden South (Malmö/Göteborg)
        ESMM: {
          name: 'ESMM FIR (Sweden South)',
          color: '#f7c948',
          coords: [
            [59.630386, 11.676075], [59.685253, 11.945786], [59.745611, 11.97815], [59.841661, 11.849122],
            [59.904017, 11.973433], [59.893439, 12.173225], [59.4634, 13.2532], [59.3045, 13.1016],
            [59.1756, 13.4126], [58.5417, 14.3713], [58.4716, 14.2022], [58.3805, 14.1606],
            [58.273, 14.1115], [58.1435, 14.095], [58.0202, 13.5804], [57.3212, 13.3626],
            [57.3059, 13.4209], [57.2551, 14.0619], [57.1339, 14.3743], [57.0717, 14.32],
            [56.5155, 14.5251], [56.412, 15.0658], [56.3741, 15.0704], [56.21, 15.0734],
            [56.2016, 15.3755], [56.2846, 16.0021], [56.3617, 16.2013], [56.52, 16.4619],
            [57.0708, 17.4711], [57.1955, 18.3338], [57.2043, 18.3643], [57.26745, 19.98917],
            [57, 19.833333], [56.345278, 18.506389], [56.095278, 18.018611], [55.85, 17.55],
            [54.916667, 15.866667], [54.916667, 15.135278], [54.916667, 14.3575], [54.916667, 12.85],
            [55.336667, 12.640833], [55.419022, 12.606892], [55.495758, 12.714764], [55.549197, 12.741236],
            [55.604897, 12.879778], [55.641111, 12.898889], [55.830475, 12.708728], [55.869886, 12.694986],
            [55.891389, 12.678333], [55.931269, 12.641142], [55.981111, 12.651944], [56.032778, 12.656944],
            [56.058611, 12.640556], [56.164167, 12.44], [56.214722, 12.368056], [58.5, 10.5],
            [58.761111, 10.592222], [58.892222, 10.638889], [58.983333, 11.116667], [59.023917, 11.153697],
            [59.083333, 11.333333], [59.022872, 11.384786], [58.9, 11.433333], [58.866667, 11.533333],
            [58.946686, 11.730014], [59.227097, 11.843294], [59.630386, 11.676075]
          ]
        },
        // ESOS FIR - Sweden (Full coverage including Stockholm and Northern Sweden)
        ESOS: {
          name: 'ESOS FIR (Sweden North)',
          color: '#f7c948',
          coords: [
            [69.06, 20.548611], [68.765556, 21.379722], [68.4712, 22.134828], [68.379275, 22.827508],
            [68.239331, 23.147778], [68.122708, 23.15895], [68.147406, 23.304192], [67.945719, 23.654256],
            [67.867514, 23.497842], [67.468258, 23.441983], [67.424353, 23.765978], [67.291267, 23.751083],
            [67.167786, 23.587222], [66.809692, 24.008042], [66.436503, 23.639358], [66.196403, 23.754808],
            [66.159358, 23.907494], [66.090278, 23.935833], [65.53, 24.14], [64.683333, 22.916667],
            [63.616667, 21.5], [63.475, 20.666667], [63.166667, 20.166667], [61.666667, 19.5],
            [61, 19.318056], [60.300833, 19.132222], [60.191667, 19.086667], [59.562778, 19.983056],
            [59.256667, 20.544167], [59, 21], [58.413333, 20.642778], [58.304444, 20.578611],
            [57.26745, 19.98917], [57.2043, 18.3643], [57.1955, 18.3338], [57.0708, 17.4711],
            [56.52, 16.4619], [56.3617, 16.2013], [56.2846, 16.0021], [56.2016, 15.3755],
            [56.21, 15.0734], [56.3741, 15.0704], [56.412, 15.0658], [56.5155, 14.5251],
            [57.0717, 14.32], [57.1339, 14.3743], [57.2551, 14.0619], [57.3059, 13.4209],
            [57.3212, 13.3626], [58.0202, 13.5804], [58.1435, 14.095], [58.273, 14.1115],
            [58.3805, 14.1606], [58.4716, 14.2022], [58.5417, 14.3713], [59.1756, 13.4126],
            [59.3045, 13.1016], [59.4634, 13.2532], [59.893439, 12.173225], [59.982903, 12.398619],
            [60.149578, 12.548617], [60.282914, 12.531944], [60.399589, 12.615278], [60.466258, 12.631942],
            [60.62366, 12.50333], [61.049614, 12.681917], [61.199622, 12.781914], [61.366294, 12.865242],
            [61.5663, 12.565219], [62, 12.219722], [62.266389, 12.298889], [62.611917, 12.056139],
            [62.651389, 12.079444], [62.747917, 12.136389], [62.902556, 12.074694], [63.000298, 12.218361],
            [63.141111, 12.090833], [63.185181, 12.050894], [63.269167, 11.974444], [63.440833, 12.1725],
            [63.478562, 12.212914], [63.593889, 12.150278], [63.631184, 12.227851], [63.672038, 12.299497],
            [63.714944, 12.330381], [63.807023, 12.463467], [63.89237, 12.577269], [63.974225, 12.68349],
            [64.057946, 12.926673], [64.095417, 13.211039], [64.079722, 13.376111], [64.555556, 13.734167],
            [64.580298, 13.654268], [64.639835, 13.705414], [64.709134, 13.791562], [64.8425, 13.956667],
            [64.951111, 14.093611], [65.118917, 14.325972], [65.247611, 14.378806], [65.309722, 14.506833],
            [65.515583, 14.498917], [65.700521, 14.541369], [65.75, 14.578333], [65.811825, 14.62544],
            [65.901312, 14.584484], [65.958201, 14.573086], [66.011966, 14.554413], [66.041075, 14.545519],
            [66.132598, 14.516181], [66.153566, 15.035548], [68.075946, 17.490404], [68.037923, 17.66691],
            [67.969344, 17.899808], [68.198784, 18.151349], [68.406005, 18.101059], [68.536441, 18.125917],
            [68.581906, 18.405757], [68.557036, 18.483766], [68.53368, 18.549924], [68.506907, 18.621208],
            [68.514167, 19], [68.35602, 19.921395], [68.390192, 19.981486], [68.442736, 20.10821],
            [68.4908, 20.226374], [68.5308, 20.02597], [68.55792, 19.937504], [68.591103, 20.052289],
            [68.665898, 20.202769], [68.802306, 20.335861], [68.926194, 20.306583], [68.95425, 20.241917],
            [69.04575, 20.060056], [69.06, 20.548611]
          ]
        },
        // EPWW FIR - Poland
        EPWW: {
          name: 'EPWW FIR (Poland)',
          color: '#4ade80',
          coords: [
            [51.3, 15.033333], [51.416667, 14.966667], [51.483333, 14.933333], [51.5, 14.833333],
            [51.566667, 14.75], [51.633333, 14.766667], [51.833333, 14.616667], [51.933333, 14.716667],
            [52.083333, 14.75], [52.15, 14.683333], [52.25, 14.7], [52.3, 14.583333],
            [52.433333, 14.566667], [52.583333, 14.6], [52.75, 14.383333], [52.85, 14.15],
            [52.966667, 14.166667], [53.05, 14.333333], [53.25, 14.433333], [53.316667, 14.416667],
            [53.55, 14.383333], [53.583333, 14.333333], [53.616667, 14.3], [53.927778, 14.226111],
            [53.987778, 14.242222], [54.126111, 14.201389], [54.127222, 14.254722], [54.916667, 14.3575],
            [54.916867, 15.134594], [54.916667, 15.866667], [55.85, 17.55], [54.603333, 19.406667],
            [54.458333, 19.641667], [54.454867, 19.694767], [54.438958, 19.893906], [54.421644, 20.123567],
            [54.413222, 20.219928], [54.401525, 20.386953], [54.389358, 20.537111], [54.363622, 20.871961],
            [54.335197, 21.205347], [54.316667, 21.466667], [54.326472, 21.767183], [54.345744, 22.254653],
            [54.359411, 22.631319], [54.365253, 22.787792], [54.393714, 22.816625], [54.402378, 22.798136],
            [54.416667, 22.85], [54.383333, 22.95], [54.383333, 23], [54.35, 23],
            [54.35, 23.066667], [54.316667, 23.033333], [54.3, 23.1], [54.3, 23.166667],
            [54.283333, 23.2], [54.25, 23.233333], [54.216667, 23.366667], [54.166667, 23.416667],
            [54.15, 23.466667], [54.133333, 23.5], [54.033333, 23.516667], [54.016667, 23.5],
            [53.983333, 23.466667], [53.933333, 23.516667], [53.85, 23.55], [53.766667, 23.566667],
            [53.75, 23.6], [53.633333, 23.6], [53.25, 23.816667], [53.233333, 23.866667],
            [53.2, 23.866667], [53.166667, 23.916667], [53.083333, 23.883333], [52.966667, 23.95],
            [52.933333, 23.933333], [52.666667, 23.916667], [52.6, 23.566667], [52.566667, 23.45],
            [52.283333, 23.166667], [52.266667, 23.183333], [52.233333, 23.183333], [52.183333, 23.416667],
            [52.183333, 23.45], [52.183333, 23.483333], [52.15, 23.5], [52.083333, 23.65],
            [51.983333, 23.683333], [51.95, 23.65], [51.833333, 23.616667], [51.8, 23.633333],
            [51.716667, 23.55], [51.666667, 23.55], [51.6, 23.55], [51.533333, 23.566667],
            [51.5, 23.616667], [51.483333, 23.666667], [51.45, 23.65], [51.416667, 23.7],
            [51.333333, 23.65], [51.283333, 23.666667], [51.266667, 23.733333], [51.216667, 23.75],
            [51.15, 23.866667], [51.1, 23.866667], [51.066667, 23.916667], [51, 23.933333],
            [50.95, 23.983333], [50.866667, 24.15], [50.833333, 24.083333], [50.833333, 23.966667],
            [50.766667, 23.966667], [50.766667, 24.033333], [50.716667, 24.033333], [50.716667, 24.066667],
            [50.633333, 24.1], [50.45, 24.05], [50.416667, 23.916667], [50.416667, 23.783333],
            [50.383333, 23.716667], [50.333333, 23.683333], [50.283333, 23.583333], [50.166667, 23.416667],
            [50.05, 23.233333], [49.533333, 22.666667], [49.333333, 22.8], [49.3, 22.8],
            [49.233333, 22.733333], [49.133333, 22.8], [49.083333, 22.9], [49.016667, 22.833333],
            [49.05, 22.683333], [49.1, 22.583333], [49.1, 22.433333], [49.15, 22.383333],
            [49.15, 22.283333], [49.216667, 22.033333], [49.35, 21.966667], [49.383333, 21.833333],
            [49.35, 21.783333], [49.45, 21.633333], [49.416667, 21.483333], [49.45, 21.283333],
            [49.4, 21.2], [49.433333, 21.133333], [49.425278, 21.066944], [49.366667, 21.1],
            [49.3, 20.933333], [49.333333, 20.833333], [49.416667, 20.733333], [49.409167, 20.65],
            [49.383333, 20.6], [49.416667, 20.466667], [49.383333, 20.4], [49.4, 20.316667],
            [49.35, 20.316667], [49.35, 20.216667], [49.3, 20.133333], [49.183333, 20.066667],
            [49.222222, 20], [49.233333, 19.916667], [49.183333, 19.833333], [49.216111, 19.758611],
            [49.283333, 19.816667], [49.4, 19.783333], [49.383333, 19.733333], [49.4, 19.65],
            [49.416667, 19.666667], [49.433333, 19.616667], [49.507778, 19.555556], [49.6, 19.45],
            [49.580556, 19.410833], [49.533333, 19.366667], [49.533333, 19.266667], [49.416667, 19.2],
            [49.4, 18.983333], [49.5, 18.983333], [49.516667, 18.85], [49.683333, 18.816667],
            [49.716667, 18.633333], [49.9, 18.516667], [49.966667, 18.216667], [50, 18.2],
            [49.983333, 18.166667], [50.066667, 18.033333], [50.033333, 18], [50.033333, 18.05],
            [50, 18.05], [50.016667, 18], [49.966667, 17.866667], [50.021389, 17.7875],
            [50.166667, 17.6], [50.2, 17.75], [50.266667, 17.716667], [50.3, 17.75],
            [50.316667, 17.683333], [50.25, 17.616667], [50.3, 17.433333], [50.266667, 17.366667],
            [50.366667, 17.2], [50.433333, 16.916667], [50.4, 16.866667], [50.283333, 17.016667],
            [50.216667, 17.016667], [50.233333, 16.95], [50.2, 16.833333], [50.1, 16.7],
            [50.122222, 16.5925], [50.216667, 16.55], [50.366667, 16.35], [50.433333, 16.2],
            [50.566667, 16.433333], [50.65, 16.333333], [50.666667, 16.233333], [50.616667, 16.2],
            [50.65, 16.1], [50.6, 16.033333], [50.683333, 16], [50.666667, 15.866667],
            [50.75, 15.816667], [50.733333, 15.75], [50.816667, 15.45], [50.766667, 15.4],
            [51, 15.25], [51.016667, 15], [51.3, 15.033333]
          ]
        },
        // EETT FIR - Estonia
        EETT: {
          name: 'EETT FIR (Estonia)',
          color: '#4fd1c5',
          coords: [
            [59.471667, 28.043333], [59.383333, 28.233333], [59.316667, 28.191667], [59.266667, 27.950000],
            [59.200000, 27.900000], [59.150000, 27.833333], [59.000000, 27.733333], [58.783333, 27.366667],
            [58.700000, 27.414444], [58.383333, 27.550000], [58.283333, 27.500000], [58.233333, 27.491667],
            [58.083333, 27.616667], [58.038333, 27.617778], [58.000000, 27.683333], [57.950000, 27.683333],
            [57.916667, 27.800000], [57.890000, 27.811667], [57.833333, 27.816667], [57.833333, 27.700000],
            [57.800000, 27.600000], [57.800000, 27.516667], [57.716667, 27.550000], [57.700000, 27.450000],
            [57.650000, 27.383333], [57.633333, 27.400000], [57.600000, 27.383333], [57.518333, 27.340000],
            [57.530000, 27.310000], [57.610000, 26.910000], [57.510000, 26.530000], [57.853889, 25.916111],
            [58.090000, 25.150000], [57.883333, 24.366667], [57.874444, 24.356667], [57.900000, 24.299444],
            [57.917222, 24.261111], [57.899167, 24.209444], [57.899167, 23.601111], [57.782778, 23.648611],
            [57.669722, 23.582222], [57.593889, 23.406111], [57.586389, 23.180833], [57.702222, 22.999167],
            [57.780556, 22.907778], [57.940833, 22.707500], [57.927500, 22.583611], [57.779167, 22.143333],
            [57.749444, 21.916111], [57.763056, 21.842778], [57.786667, 21.716667], [57.856667, 21.646667],
            [57.895000, 21.613333], [58.021111, 21.542500], [58.116667, 21.483333], [58.413333, 20.642778],
            [59.000000, 21.000000], [59.883333, 24.850000], [59.908333, 25.333333], [59.883333, 25.866667],
            [59.866667, 25.975000], [59.611667, 27.636667], [59.471667, 28.043333]
          ]
        },
        // EVRR FIR - Latvia
        EVRR: {
          name: 'EVRR FIR (Latvia)',
          color: '#a66cff',
          coords: [
            [57.000000, 19.833333], [57.267450, 19.989170], [58.304444, 20.578611], [58.413333, 20.642778],
            [58.116667, 21.483333], [58.021111, 21.542500], [57.895000, 21.613333], [57.856667, 21.646667],
            [57.786667, 21.716667], [57.773889, 21.791667], [57.763056, 21.842778], [57.749444, 21.916111],
            [57.779167, 22.143333], [57.825000, 22.278889], [57.927500, 22.583611], [57.940833, 22.707500],
            [57.780556, 22.907778], [57.702222, 22.999167], [57.586389, 23.180833], [57.593889, 23.406111],
            [57.669722, 23.582222], [57.782778, 23.648611], [57.899167, 23.601111], [57.899167, 24.209444],
            [57.917222, 24.261111], [57.900000, 24.299444], [57.874444, 24.356667], [57.883333, 24.366667],
            [58.090000, 25.150000], [57.853889, 25.916111], [57.510000, 26.530000], [57.610000, 26.910000],
            [57.530000, 27.310000], [57.518333, 27.340000], [57.533333, 27.416667], [57.533333, 27.550000],
            [57.500000, 27.550000], [57.450000, 27.516667], [57.383333, 27.700000], [57.300000, 27.866667],
            [57.183333, 27.833333], [57.100000, 27.733333], [57.083333, 27.750000], [57.016667, 27.716667],
            [57.000000, 27.750000], [56.933333, 27.733333], [56.916667, 27.683333], [56.833333, 27.666667],
            [56.866667, 27.833333], [56.826617, 27.995206], [56.751667, 27.901667], [56.683333, 28.000000],
            [56.583333, 28.033333], [56.566667, 28.150000], [56.516667, 28.116667], [56.478611, 28.142500],
            [56.433333, 28.183333], [56.366667, 28.183333], [56.266667, 28.250000], [56.200000, 28.200000],
            [56.173333, 28.146667], [55.807075, 27.556342], [55.812778, 26.978056], [55.680556, 26.630556],
            [55.985556, 25.947500], [56.173425, 25.138350], [56.445997, 24.887747], [56.368889, 24.630278],
            [56.262281, 24.468650], [56.278611, 24.065278], [56.371389, 23.755556], [56.313611, 23.507311],
            [56.372222, 23.260278], [56.371111, 23.206111], [56.346608, 23.176686], [56.426525, 22.142086],
            [56.294167, 21.535278], [56.179722, 21.279167], [56.073889, 21.093611], [56.069167, 21.064444],
            [56.067222, 20.747778], [56.066667, 20.666667], [56.146111, 20.082222], [56.297778, 18.898333],
            [56.345278, 18.506389], [57.000000, 19.833333]
          ]
        },
        // EYVL FIR - Lithuania
        EYVL: {
          name: 'EYVL FIR (Lithuania)',
          color: '#ff6b6b',
          coords: [
            [56.095278, 18.018611], [56.345278, 18.506389], [56.297778, 18.898333], [56.146111, 20.082222],
            [56.066667, 20.666667], [56.067222, 20.747778], [56.069167, 21.064444], [56.073889, 21.093611],
            [56.179722, 21.279167], [56.294167, 21.535278], [56.426525, 22.142086], [56.346608, 23.176686],
            [56.371111, 23.206111], [56.372222, 23.260278], [56.313611, 23.507311], [56.371389, 23.755556],
            [56.278611, 24.065278], [56.262281, 24.468650], [56.368889, 24.630278], [56.445997, 24.887747],
            [56.173425, 25.138350], [55.985556, 25.947500], [55.680556, 26.630556], [55.606700, 26.647122],
            [55.449711, 26.554875], [55.376372, 26.507319], [55.357464, 26.463203], [55.318503, 26.458617],
            [55.299594, 26.530811], [55.301886, 26.809842], [55.296158, 26.851667], [55.264644, 26.856250],
            [55.200472, 26.721033], [55.142606, 26.668894], [55.123697, 26.509039], [55.101353, 26.451169],
            [55.132292, 26.332567], [55.138022, 26.272408], [55.092758, 26.235164], [55.045203, 26.241467],
            [55.000000, 26.216667], [54.965244, 26.143825], [54.881336, 25.854722], [54.786425, 25.770667],
            [54.626031, 25.737875], [54.555897, 25.728669], [54.490006, 25.685697], [54.329003, 25.584858],
            [54.304939, 25.595172], [54.283333, 25.716667], [54.245353, 25.779089], [54.166667, 25.783333],
            [54.135917, 25.715492], [54.155397, 25.571678], [54.181181, 25.585431], [54.253375, 25.543033],
            [54.266553, 25.456514], [54.251656, 25.319578], [54.204672, 25.231342], [54.178889, 25.175767],
            [54.133333, 25.050000], [54.066017, 24.806781], [53.971478, 24.803342], [53.947989, 24.746619],
            [53.994969, 24.657239], [53.937675, 24.520875], [53.891264, 24.411439], [53.903297, 24.289400],
            [53.939392, 24.196008], [53.929081, 23.927292], [53.900000, 23.800000], [53.909025, 23.618467],
            [53.933333, 23.516667], [53.983333, 23.466667], [54.016667, 23.500000], [54.033333, 23.516667],
            [54.133333, 23.500000], [54.150000, 23.466667], [54.166667, 23.416667], [54.216667, 23.366667],
            [54.250000, 23.233333], [54.283333, 23.200000], [54.300000, 23.166667], [54.300000, 23.100000],
            [54.316667, 23.033333], [54.350000, 23.066667], [54.350000, 23.000000], [54.383333, 23.000000],
            [54.383333, 22.950000], [54.416667, 22.850000], [54.402378, 22.798136], [54.401531, 22.757261],
            [54.447422, 22.730336], [54.498961, 22.694508], [54.537567, 22.689919], [54.570347, 22.706850],
            [54.603439, 22.697614], [54.640572, 22.751428], [54.658203, 22.750967], [54.709389, 22.732692],
            [54.740783, 22.772008], [54.774300, 22.851925], [54.797375, 22.881053], [54.839600, 22.871083],
            [54.867767, 22.849172], [54.902683, 22.845656], [54.911217, 22.795242], [54.942086, 22.767058],
            [54.991069, 22.683592], [55.020236, 22.612461], [55.071814, 22.580897], [55.047878, 22.469069],
            [55.056661, 22.419456], [55.063564, 22.232322], [55.050508, 22.141711], [55.037169, 22.131314],
            [55.026189, 22.071044], [55.061675, 22.037100], [55.085522, 22.034539], [55.075644, 21.952064],
            [55.098675, 21.849992], [55.120014, 21.821567], [55.127944, 21.748647], [55.187889, 21.627361],
            [55.198719, 21.575375], [55.189239, 21.521603], [55.194489, 21.502081], [55.209853, 21.482778],
            [55.231011, 21.445583], [55.252811, 21.434189], [55.290681, 21.388639], [55.284775, 21.354272],
            [55.245700, 21.276489], [55.281667, 20.956667], [55.373333, 20.643333], [56.095278, 18.018611]
          ]
        }
      };

      let firLayerGroup = null;
      let firEnabled = false;

      // Russian aircraft tracks layer
      let russianTracksLayerGroup = null;
      let russianTracksData = [];

      function drawRussianTracks() {
        if (russianTracksLayerGroup) {
          map.removeLayer(russianTracksLayerGroup);
          russianTracksLayerGroup = null;
        }
        if (!russianTracksData || russianTracksData.length === 0) return;
        
        russianTracksLayerGroup = L.layerGroup();
        russianTracksData.forEach((track) => {
          const label = track.callsign || track.icao24;
          const baseColor = track.is_military ? '#ff0000' : '#ff6b6b';
          
          // If track has segments, draw each segment separately
          if (track.segments && track.segments.length > 0) {
            track.segments.forEach((segment, segIndex) => {
              const segCoords = segment.positions
                .filter(p => p.latitude != null && p.longitude != null)
                .map(p => [p.latitude, p.longitude]);
              
              if (segCoords.length < 2) return;
              
              // Segments with gaps before them are drawn with lower opacity and more spaced dashes
              const hasGap = segment.hasGapBefore;
              const gapMinutes = segment.gapDurationSeconds ? Math.round(segment.gapDurationSeconds / 60) : 0;
              
              const polyline = L.polyline(segCoords, {
                color: hasGap ? '#ffaa00' : baseColor,  // Orange for gap segments
                weight: hasGap ? 1.5 : 2,
                opacity: hasGap ? 0.4 : 0.7,
                dashArray: hasGap ? '2, 8' : '5, 5'  // More sparse dashes for gap segments
              });
              
              let tooltipText = label + (track.is_military ? ' (MIL)' : '');
              if (hasGap && gapMinutes > 0) {
                tooltipText += ' [' + gapMinutes + 'min gap - estimated path]';
              }
              polyline.bindTooltip(tooltipText, {
                permanent: false,
                direction: 'center',
                className: 'russian-track-tooltip'
              });
              
              russianTracksLayerGroup.addLayer(polyline);
              
              // Draw connecting line between segments (the uncertain part)
              if (segIndex > 0 && hasGap) {
                const prevSegment = track.segments[segIndex - 1];
                if (prevSegment.positions.length > 0) {
                  const lastPrevPos = prevSegment.positions[prevSegment.positions.length - 1];
                  const firstCurrPos = segment.positions[0];
                  if (lastPrevPos.latitude && lastPrevPos.longitude && 
                      firstCurrPos.latitude && firstCurrPos.longitude) {
                    const gapLine = L.polyline([
                      [lastPrevPos.latitude, lastPrevPos.longitude],
                      [firstCurrPos.latitude, firstCurrPos.longitude]
                    ], {
                      color: '#888888',  // Gray for unknown path
                      weight: 1,
                      opacity: 0.3,
                      dashArray: '1, 6'  // Very sparse dashes
                    });
                    gapLine.bindTooltip('Unknown path (' + gapMinutes + 'min gap)', {
                      permanent: false,
                      direction: 'center'
                    });
                    russianTracksLayerGroup.addLayer(gapLine);
                  }
                }
              }
            });
          } else {
            // Fallback: draw all positions as single track (legacy behavior)
            const coords = track.positions
              .filter(p => p.latitude != null && p.longitude != null)
              .map(p => [p.latitude, p.longitude]);
            
            if (coords.length < 2) return;
            
            const polyline = L.polyline(coords, {
              color: baseColor,
              weight: 2,
              opacity: 0.7,
              dashArray: '5, 5'
            });
            
            polyline.bindTooltip(label + (track.is_military ? ' (MIL)' : ''), {
              permanent: false,
              direction: 'center',
              className: 'russian-track-tooltip'
            });
            
            russianTracksLayerGroup.addLayer(polyline);
          }
        });
        russianTracksLayerGroup.addTo(map);
      }

      function drawFirBoundaries() {
        if (firLayerGroup) {
          map.removeLayer(firLayerGroup);
          firLayerGroup = null;
        }
        if (!firEnabled) return;
        
        firLayerGroup = L.layerGroup();
        Object.entries(firBoundaries).forEach(([code, fir]) => {
          const polygon = L.polygon(fir.coords, {
            color: fir.color,
            weight: 2,
            opacity: 0.8,
            fillColor: fir.color,
            fillOpacity: 0.1,
            dashArray: '5, 5'
          });
          polygon.bindTooltip(fir.name, {
            permanent: false,
            direction: 'center',
            className: 'fir-tooltip'
          });
          firLayerGroup.addLayer(polygon);
        });
        firLayerGroup.addTo(map);
      }

      const recenterButton = L.DomUtil.create('button', 'recenter-control', map.getContainer());
      recenterButton.type = 'button';
      recenterButton.title = 'Recenter';
      recenterButton.innerHTML =
        '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">' +
        '<path fill="#0e1116" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>' +
        '</svg>';
      L.DomEvent.disableClickPropagation(recenterButton);
      L.DomEvent.disableScrollPropagation(recenterButton);
      L.DomEvent.on(recenterButton, 'click', (event) => {
        L.DomEvent.stopPropagation(event);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'recenter' }));
        }
      });

      const markers = new Map();
      const traces = new Map();
      const traceLines = new Map();
      let tracingEnabled = false;
      let proximityEnabled = false;
      let mePosition = null;
      let meHeading = null;
      let closestTarget = null;
      let headingLine = null;
      let closestLine = null;
      let closestLabel = null;
      const ICON_HEADING_OFFSET = 0;
      const lastPositions = new Map();
      let meMarker = null;

      function computeHeading(prev, next) {
        if (!prev) return null;
        const lat1 = (prev.lat * Math.PI) / 180;
        const lat2 = (next.lat * Math.PI) / 180;
        const dLon = ((next.lon - prev.lon) * Math.PI) / 180;
        const y = Math.sin(dLon) * Math.cos(lat2);
        const x =
          Math.cos(lat1) * Math.sin(lat2) -
          Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
        if (!Number.isFinite(x) || !Number.isFinite(y)) return null;
        if (x === 0 && y === 0) return null;
        // Bearing from north (0deg = north, 90deg = east)
        const radians = Math.atan2(y, x);
        const deg = (radians * 180) / Math.PI;
        return (deg + 360) % 360;
      }

      function updateHeadingLine() {
        if (!proximityEnabled) {
          if (headingLine) {
            map.removeLayer(headingLine);
            headingLine = null;
          }
          return;
        }
        if (!mePosition || typeof meHeading !== 'number' || meHeading < 0) {
          if (headingLine) {
            map.removeLayer(headingLine);
            headingLine = null;
          }
          return;
        }
        const distanceKm = 1;
        const R = 6371;
        const bearing = (meHeading * Math.PI) / 180;
        const lat1 = (mePosition.lat * Math.PI) / 180;
        const lon1 = (mePosition.lng * Math.PI) / 180;
        const d = distanceKm / R;
        const lat2 = Math.asin(
          Math.sin(lat1) * Math.cos(d) + Math.cos(lat1) * Math.sin(d) * Math.cos(bearing)
        );
        const lon2 =
          lon1 +
          Math.atan2(
            Math.sin(bearing) * Math.sin(d) * Math.cos(lat1),
            Math.cos(d) - Math.sin(lat1) * Math.sin(lat2)
          );
        const end = [lat2 * (180 / Math.PI), lon2 * (180 / Math.PI)];
        if (!headingLine) {
          headingLine = L.polyline(
            [
              [mePosition.lat, mePosition.lng],
              end
            ],
            { color: '#7bb6f7', weight: 2, opacity: 0.7 }
          ).addTo(map);
        } else {
          headingLine.setLatLngs([
            [mePosition.lat, mePosition.lng],
            end
          ]);
        }
      }

      function updateClosestLine() {
        if (!proximityEnabled) {
          if (closestLine) {
            map.removeLayer(closestLine);
            closestLine = null;
          }
          if (closestLabel) {
            map.removeLayer(closestLabel);
            closestLabel = null;
          }
          return;
        }
        if (!mePosition || !closestTarget) {
          if (closestLine) {
            map.removeLayer(closestLine);
            closestLine = null;
          }
          if (closestLabel) {
            map.removeLayer(closestLabel);
            closestLabel = null;
          }
          return;
        }
        if (!closestLine) {
          closestLine = L.polyline(
            [
              [mePosition.lat, mePosition.lng],
              [closestTarget.lat, closestTarget.lon]
            ],
            { color: '#7bb6f7', weight: 2, opacity: 0.7 }
          ).addTo(map);
        } else {
          closestLine.setLatLngs([
            [mePosition.lat, mePosition.lng],
            [closestTarget.lat, closestTarget.lon]
          ]);
        }
        const mid = [
          (mePosition.lat + closestTarget.lat) / 2,
          (mePosition.lng + closestTarget.lon) / 2
        ];
        const distKm = map.distance(
          [mePosition.lat, mePosition.lng],
          [closestTarget.lat, closestTarget.lon]
        ) / 1000;
        const labelText = String(distKm.toFixed(1)) + ' km';
        if (!closestLabel) {
          closestLabel = L.tooltip({
            permanent: true,
            direction: 'top',
            className: 'vehicle-tooltip',
            offset: [0, -6]
          })
            .setLatLng(mid)
            .setContent(labelText)
            .addTo(map);
        } else {
          closestLabel.setLatLng(mid);
          closestLabel.setContent(labelText);
        }
      }

      function updateMe(lat, lon, heading) {
        if (!meMarker) {
          meMarker = L.circleMarker([lat, lon], {
            radius: 6,
            className: 'me-dot',
            fillOpacity: 0.9
          }).addTo(map);
        } else {
          meMarker.setLatLng([lat, lon]);
        }
        mePosition = { lat, lng: lon };
        meHeading = typeof heading === 'number' ? heading : null;
        if (proximityEnabled) {
          updateHeadingLine();
          updateClosestLine();
        }
      }

      function clearTraces() {
        for (const line of traceLines.values()) {
          map.removeLayer(line);
        }
        traceLines.clear();
        traces.clear();
      }

      function updateTrace(key, lat, lon) {
        if (!tracingEnabled) return;
        let path = traces.get(key);
        if (!path) {
          path = [];
          traces.set(key, path);
        }
        path.push([lat, lon]);
        if (path.length > 40) path.shift();
        let line = traceLines.get(key);
        if (!line) {
          line = L.polyline(path, {
            color: '#f7c948',
            weight: 2,
            opacity: 0.6
          }).addTo(map);
          traceLines.set(key, line);
        } else {
          line.setLatLngs(path);
        }
      }

      // Russian ICAO prefixes: 140-157
      function isRussianAircraft(hex) {
        if (!hex) return false;
        const prefix = hex.toLowerCase().substring(0, 3);
        const russianPrefixes = [
          '140', '141', '142', '143', '144', '145', '146', '147',
          '148', '149', '14a', '14b', '14c', '14d', '14e', '14f',
          '150', '151', '152', '153', '154', '155', '156', '157'
        ];
        return russianPrefixes.includes(prefix);
      }

      let russianModeEnabled = false;

      function getAircraftSize(item) {
        const category = String(item.category || '').toUpperCase();
        if (category.startsWith('A')) {
          const code = category.slice(1);
          if (code === '1' || code === '2') return 18;
          if (code === '3' || code === '4') return 24;
          if (code === '5' || code === '6' || code === '7') return 30;
        }

        const desc = String(item.desc || item.t || item.type || item.r || '').toUpperCase();
        if (/(A380|B747|B748)/.test(desc)) return 32;
        if (/(A350|B777|B787|B767|A330|A340)/.test(desc)) return 30;
        if (/(A321|A320|A319|B737|B738|B739|E190|E195|E170|E175)/.test(desc)) return 26;
        if (/(CESSNA|C172|C152|C208|PIPER|BEECH|CIRRUS|DA40|DA42)/.test(desc)) return 20;
        return 24;
      }

      function updateAircraft(items) {
        const next = new Set();
        for (const item of items) {
          if (typeof item.lat !== 'number' || typeof item.lon !== 'number') continue;
          const key = item.hex || (item.flight ? item.flight.trim() : null);
          if (!key) continue;
          next.add(key);
          const label = [
            item.flight ? item.flight.trim() : 'Unknown',
            item.hex ? item.hex.toUpperCase() : 'N/A',
            item.alt_baro ? Math.round(item.alt_baro) + ' ft' : 'Alt N/A',
            item.gs ? Math.round(item.gs) + ' kt' : 'GS N/A',
            item.military ? 'Military (possible)' : null
          ]
            .filter((entry) => entry)
            .join('<br/>');

          const prev = lastPositions.get(key) || null;
          const rawHeading = computeHeading(prev, { lat: item.lat, lon: item.lon });
          const movementHeading = typeof rawHeading === 'number' ? rawHeading : null;
          const rotation =
            typeof item.track === 'number'
              ? item.track
              : typeof movementHeading === 'number'
                ? movementHeading
                : 0;
          const size = getAircraftSize(item);
          const altValue =
            typeof item.alt_baro === 'number' && !Number.isNaN(item.alt_baro)
              ? item.alt_baro
              : null;
          const altOk = tracingEnabled && altValue !== null ? altValue >= 30000 : false;
          const lowAlt = tracingEnabled && (altValue === null || altValue <= 5000);
          const noSpeed =
            tracingEnabled && (!(typeof item.gs === 'number') || Number.isNaN(item.gs) || item.gs <= 0);
          const isRussian = isRussianAircraft(item.hex);
          const iconHtml =
            '<div class="aircraft-icon' +
            (russianModeEnabled && isRussian ? ' russian' : '') +
            (altOk ? ' alt-ok' : '') +
            (lowAlt ? ' low-alt' : '') +
            (noSpeed ? ' no-speed' : '') +
            (item.military ? ' military' : '') +
            '" style="--aircraft-size: ' +
            size +
            'px;">' +
            '<span class="material-icons" style="transform: rotate(' +
            (rotation + ICON_HEADING_OFFSET) +
            'deg);">airplanemode_active</span>' +
            '</div>';
          const icon = L.divIcon({
            html: iconHtml,
            className: '',
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
          });

          if (!markers.has(key)) {
            const marker = L.marker([item.lat, item.lon], { icon }).addTo(map);
            marker._aircraft = item;
            marker.on('click', () => {
              if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({ type: 'select', item: marker._aircraft || item })
                );
              }
            });
            markers.set(key, marker);
          } else {
            const marker = markers.get(key);
            marker.setLatLng([item.lat, item.lon]);
            marker.setIcon(icon);
            marker._aircraft = item;
          }
          updateTrace(key, item.lat, item.lon);
          lastPositions.set(key, { lat: item.lat, lon: item.lon });
        }

        for (const [key, marker] of markers.entries()) {
          if (!next.has(key)) {
            map.removeLayer(marker);
            markers.delete(key);
            lastPositions.delete(key);
            if (traceLines.has(key)) {
              map.removeLayer(traceLines.get(key));
              traceLines.delete(key);
              traces.delete(key);
            }
          }
        }
      }

      function setCenter(lat, lon, zoom) {
        const nextZoom = Number.isFinite(zoom) ? zoom : map.getZoom();
        map.setView([lat, lon], nextZoom, { animate: true });
      }

      const busMarkers = new Map();
      let selectedBusKey = null;
      const modeColors = {
        BUS: '#3fa9f5',
        TRAM: '#2ecc71',
        SUBWAY: '#ff6b6b',
        RAIL: '#a66cff',
        FERRY: '#00b3b3',
        UNKNOWN: '#3fa9f5'
      };

      function clearBusMarkers() {
        for (const entry of busMarkers.values()) {
          map.removeLayer(entry.marker);
        }
        busMarkers.clear();
      }

      function buildIconSvg(color, kind) {
        const size = kind === 'TRAM' ? 27 : kind === 'BUS' ? 20 : 22;
        if (kind === 'BUS') {
          return (
            '<svg viewBox="0 0 24 24" width="' +
            size +
            '" height="' +
            size +
            '" aria-hidden="true">' +
            '<path fill="' +
            color +
            '" stroke="#0e1116" stroke-width="1" d="M7 3h10a3 3 0 0 1 3 3v9a4 4 0 0 1-4 4l1.5 1.5V21H6.5v-.5L8 19a4 4 0 0 1-4-4V6a3 3 0 0 1 3-3zm0 4v5h10V7H7zm2 9a1.6 1.6 0 1 0 0-3.2A1.6 1.6 0 0 0 9 16zm6 0a1.6 1.6 0 1 0 0-3.2A1.6 1.6 0 0 0 15 16z"/>' +
            '</svg>'
          );
        }
        if (kind === 'RAIL') {
          return (
            '<svg viewBox="0 0 24 24" width="' +
            size +
            '" height="' +
            size +
            '" aria-hidden="true">' +
            '<path fill="' +
            color +
            '" stroke="#0e1116" stroke-width="1" d="M7 3h10a3 3 0 0 1 3 3v8a4 4 0 0 1-4 4l2 2v1H6v-1l2-2a4 4 0 0 1-4-4V6a3 3 0 0 1 3-3zm10 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM7 15a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM6 7h12v3H6z"/>' +
            '</svg>'
          );
        }
        if (kind === 'SUBWAY') {
          return (
            '<svg viewBox="0 0 24 24" width="' +
            size +
            '" height="' +
            size +
            '" aria-hidden="true">' +
            '<path fill="' +
            color +
            '" stroke="#0e1116" stroke-width="1" d="M7 4h10a3 3 0 0 1 3 3v7a4 4 0 0 1-4 4l1.5 1.5V20H6.5v-.5L8 18a4 4 0 0 1-4-4V7a3 3 0 0 1 3-3zm0 5v3h10V9H7zm2 8a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm6 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>' +
            '</svg>'
          );
        }
        if (kind === 'TRAM') {
          return (
            '<svg viewBox="0 0 24 24" width="' +
            size +
            '" height="' +
            size +
            '" aria-hidden="true">' +
            '<path fill="' +
            color +
            '" stroke="#0e1116" stroke-width="1" d="M8 2h8l2 4h-2v8a4 4 0 0 1-4 4l1.5 2V21H10v-1l1.5-2a4 4 0 0 1-4-4V6H6l2-4zm1 6v4h6V8H9zm1 8a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>' +
            '</svg>'
          );
        }
        if (kind === 'FERRY') {
          return (
            '<svg viewBox="0 0 24 24" width="' +
            size +
            '" height="' +
            size +
            '" aria-hidden="true">' +
            '<path fill="' +
            color +
            '" stroke="#0e1116" stroke-width="1" d="M4 12l8-3 8 3v4H4v-4zm0 6h16l2 3H2l2-3zm2-9V5h12v4l-6-2-6 2z"/>' +
            '</svg>'
          );
        }
        return '';
      }

      function updateBusMarker(bus) {
        const lat = bus.lat;
        const lon = bus.lon;
        const key = bus.key;
        const label = bus.label || bus.route || 'HSL Bus';
        const mode = bus.mode || 'UNKNOWN';
        const color = modeColors[mode] || modeColors.UNKNOWN;
        if (typeof lat !== 'number' || typeof lon !== 'number') return;

        if (!busMarkers.has(key)) {
          if (
            mode === 'RAIL' ||
            mode === 'FERRY' ||
            mode === 'SUBWAY' ||
            mode === 'TRAM' ||
            mode === 'BUS'
          ) {
            const iconSize = mode === 'TRAM' ? 27 : mode === 'BUS' ? 20 : 22;
            const icon = L.divIcon({
              className: 'bus-marker',
              html: buildIconSvg(color, mode),
              iconSize: [iconSize, iconSize],
              iconAnchor: [iconSize / 2, iconSize / 2]
            });
            const marker = L.marker([lat, lon], { icon }).addTo(map);
            marker.bindTooltip(label, {
              direction: 'top',
              offset: [0, -8],
              className: 'vehicle-tooltip'
            });
            marker.on('click', () => {
              selectedBusKey = key;
              marker.openTooltip();
            });
            marker.on('touchstart', () => {
              selectedBusKey = key;
              marker.openTooltip();
            });
            busMarkers.set(key, { marker, kind: 'icon' });
          } else {
            const marker = L.circleMarker([lat, lon], {
              radius: 6,
              className: 'bus-dot',
              fillOpacity: 0.9,
              color,
              fillColor: color
            }).addTo(map);
            marker.bindTooltip(label, {
              direction: 'top',
              offset: [0, -6],
              className: 'vehicle-tooltip'
            });
            marker.on('click', () => {
              selectedBusKey = key;
              marker.openTooltip();
            });
            marker.on('touchstart', () => {
              selectedBusKey = key;
              marker.openTooltip();
            });
            busMarkers.set(key, { marker, kind: 'dot' });
          }
        } else {
          const entry = busMarkers.get(key);
          const marker = entry.marker;
          marker.setLatLng([lat, lon]);
          marker.setTooltipContent(label);
          if (entry.kind === 'dot' && marker.setStyle) {
            marker.setStyle({ color, fillColor: color });
          } else if (entry.kind === 'icon' && marker.setIcon) {
            const iconSize = mode === 'TRAM' ? 27 : mode === 'BUS' ? 20 : 22;
            const icon = L.divIcon({
              className: 'bus-marker',
              html: buildIconSvg(color, mode),
              iconSize: [iconSize, iconSize],
              iconAnchor: [iconSize / 2, iconSize / 2]
            });
            marker.setIcon(icon);
          }
        }
        if (selectedBusKey === key) {
          const entry = busMarkers.get(key);
          if (entry && entry.marker && entry.marker.openTooltip) {
            entry.marker.openTooltip();
          }
        }
      }

      /* SURPRISE_FEATURE: Scripts injected from component */
      ${SURPRISE_ENABLED ? SURPRISE_SCRIPTS(SURPRISE_CONFIG.icon) : ''}

      function handleMessage(event) {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'aircraft') updateAircraft(data.items || []);
          /* SURPRISE_FEATURE: Message handlers from component */
          ${SURPRISE_ENABLED ? SURPRISE_MESSAGE_HANDLERS : ''}
          if (data.type === 'center') setCenter(data.lat, data.lon, data.zoom);
          if (data.type === 'me') updateMe(data.lat, data.lon, data.heading);
          if (data.type === 'hslBus') updateBusMarker(data.bus);
          if (data.type === 'hslClear') clearBusMarkers();
          if (data.type === 'trace') {
            tracingEnabled = !!data.enabled;
            if (!tracingEnabled) {
              clearTraces();
            }
          }
          if (data.type === 'proximity') {
            proximityEnabled = !!data.enabled;
            if (!proximityEnabled) {
              if (headingLine) {
                map.removeLayer(headingLine);
                headingLine = null;
              }
              if (closestLine) {
                map.removeLayer(closestLine);
                closestLine = null;
              }
              if (closestLabel) {
                map.removeLayer(closestLabel);
                closestLabel = null;
              }
            } else {
              updateHeadingLine();
              updateClosestLine();
            }
          }
          if (data.type === 'closest') {
            if (typeof data.lat === 'number' && typeof data.lon === 'number') {
              closestTarget = { lat: data.lat, lon: data.lon };
            } else {
              closestTarget = null;
            }
            updateClosestLine();
          }
          if (data.type === 'fir') {
            firEnabled = !!data.enabled;
            drawFirBoundaries();
          }
          if (data.type === 'russianTracks') {
            russianTracksData = data.tracks || [];
            drawRussianTracks();
          }
          if (data.type === 'russianTracksEnabled') {
            russianModeEnabled = !!data.enabled;
            if (!data.enabled) {
              russianTracksData = [];
              drawRussianTracks();
            }
          }
          if (data.type === 'mapClick') {
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(
                JSON.stringify({ type: 'mapClick', lat: data.lat, lon: data.lon })
              );
            }
          }
          if (data.type === 'ready') {
            // handled in React Native
          }
        } catch (e) {}
      }

      document.addEventListener('message', handleMessage);
      window.addEventListener('message', handleMessage);

      window.addEventListener('load', () => {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'ready' }));
        }
      });

      map.on('click', function (e) {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'mapClick',
              lat: e.latlng.lat,
              lon: e.latlng.lng,
              zoom: map.getZoom()
            })
          );
        }
      });

      window.addEventListener('error', (event) => {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(
            JSON.stringify({ type: 'jsError', message: String(event.message || 'JS error') })
          );
        }
      });

      window.addEventListener('unhandledrejection', (event) => {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'jsError',
              message: String(event.reason && event.reason.message ? event.reason.message : event.reason)
            })
          );
        }
      });
    </script>
  </body>
</html>`;
}

export default function HomeScreen() {
  const webViewRef = useRef<WebView>(null);
  const {
    radiusKm,
    useCustomCenter,
    customCenter,
    setCustomCenter,
    showHslBuses,
    showHslBus,
    showHslTram,
    showHslMetro,
    showHslRail,
    showHslFerry,
    enableTracing,
    enableProximity,
    showFirAirspaces,
    showRussianAircraft,
    hslRadiusEnabled,
    hslRadiusKm,
    hslLineFilter,
    setHslLineFilter,
  } = useSettings();
  const [permissionStatus, setPermissionStatus] = useState<'unknown' | 'granted' | 'denied'>(
    'unknown'
  );
  const [location, setLocation] = useState<Location.LocationObject | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [lastUpdated, setLastUpdated] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [webError, setWebError] = useState<string | null>(null);
  const [webReady, setWebReady] = useState(false);
  const [hslStatus, setHslStatus] = useState<string | null>(null);
  const [hslLastMessage, setHslLastMessage] = useState<string | null>(null);
  const routeInfoCacheRef = useRef<Map<string, { shortName: string; mode: string }>>(new Map());
  const routeLookupInFlightRef = useRef<
    Map<string, Promise<{ shortName: string; mode: string } | null>>
  >(
    new Map()
  );
  const tripInfoCacheRef = useRef<Map<string, { shortName: string; mode: string }>>(new Map());
  const tripLookupInFlightRef = useRef<
    Map<string, Promise<{ shortName: string; mode: string } | null>>
  >(
    new Map()
  );
  const [selectedAircraft, setSelectedAircraft] = useState<Aircraft | null>(null);
  const selectedKeyRef = useRef<string | null>(null);
  const latestAircraftRef = useRef<Aircraft[]>([]);
  const [detailsExpanded, setDetailsExpanded] = useState(false);
  const [headerCollapsed, setHeaderCollapsed] = useState(true);
  const militaryHexSet = useMemo(() => {
    // Derived from ADSBExchange basic-ac-db (mil=true)
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    return new Set(require('@/assets/military_hex.json') as string[]);
  }, []);
  const hasCentered = useRef(false);
  const centeredSourceRef = useRef<'gps' | 'demo' | 'custom' | null>(null);
  const watchRef = useRef<Location.LocationSubscription | null>(null);
  const lastCoordsRef = useRef<{ latitude: number; longitude: number } | null>(null);
  const lastHeadingRef = useRef<number | null>(null);
  const lastCustomCenterRef = useRef<{ latitude: number; longitude: number } | null>(null);
  const lastCustomZoomRef = useRef<number | null>(null);

  const html = useMemo(() => buildMapHtml(), []);

  // Russian ICAO 24-bit address prefixes (140-157 hex)
  const isRussianAircraft = useCallback((hex: string | undefined): boolean => {
    if (!hex) return false;
    const prefix = hex.toLowerCase().substring(0, 3);
    const russianPrefixes = [
      '140', '141', '142', '143', '144', '145', '146', '147',
      '148', '149', '14a', '14b', '14c', '14d', '14e', '14f',
      '150', '151', '152', '153', '154', '155', '156', '157'
    ];
    return russianPrefixes.includes(prefix);
  }, []);

  const airlineLookup = useMemo(() => {
    // Loaded from OpenFlights airline dataset (ICAO -> name)
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    return require('@/assets/airlines.json') as Record<string, string>;
  }, []);
  const getAirlineGuess = (callsign?: string) => {
    if (!callsign) return '—';
    const prefix = callsign.replace(/\s+/g, '').toUpperCase().slice(0, 3);
    const overrides: Record<string, string> = {
      WUK: 'Wizz Air UK',
    };
    const name = overrides[prefix] || airlineLookup[prefix];
    return name || `Unknown (${prefix || 'N/A'})`;
  };
  const getAircraftKey = (item?: Aircraft | null) => {
    if (!item) return null;
    const hex = typeof item.hex === 'string' ? item.hex.trim().toLowerCase() : '';
    if (hex) return `hex:${hex}`;
    const flight = typeof item.flight === 'string' ? item.flight.trim().toLowerCase() : '';
    if (flight) return `flight:${flight}`;
    return null;
  };
  const isSameAircraftSnapshot = (a: Aircraft | null, b: Aircraft | null) => {
    if (!a || !b) return false;
    return (
      a.hex === b.hex &&
      a.flight === b.flight &&
      a.lat === b.lat &&
      a.lon === b.lon &&
      a.alt_baro === b.alt_baro &&
      a.gs === b.gs &&
      a.track === b.track
    );
  };
  useEffect(() => {
    selectedKeyRef.current = getAircraftKey(selectedAircraft);
  }, [selectedAircraft]);
  const formatValue = (value: unknown) => {
    if (value === null || value === undefined) return '—';
    if (typeof value === 'number') return Number.isInteger(value) ? String(value) : value.toFixed(2);
    if (typeof value === 'string' && value.trim() === '') return '—';
    return String(value);
  };
  const distanceKm = (lat1: number, lon1: number, lat2: number, lon2: number) => {
    const toRad = (value: number) => (value * Math.PI) / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return 6371 * c;
  };
  const sendProximityTarget = (
    items: Aircraft[],
    center: { latitude: number; longitude: number }
  ) => {
    const selectedKey = selectedKeyRef.current;
    let target: Aircraft | null = null;
    if (selectedKey) {
      target = items.find((item) => getAircraftKey(item) === selectedKey) || null;
    }
    if (!target) {
      let best = Number.POSITIVE_INFINITY;
      for (const item of items) {
        if (typeof item.lat !== 'number' || typeof item.lon !== 'number') continue;
        const d = distanceKm(center.latitude, center.longitude, item.lat, item.lon);
        if (d < best) {
          best = d;
          target = item;
        }
      }
    }
    if (target && typeof target.lat === 'number' && typeof target.lon === 'number') {
      webViewRef.current?.postMessage(
        JSON.stringify({ type: 'closest', lat: target.lat, lon: target.lon })
      );
    } else {
      webViewRef.current?.postMessage(JSON.stringify({ type: 'closest', lat: null, lon: null }));
    }
  };

  const getRouteInfo = useCallback(async (routeId?: string | null) => {
    if (!routeId) return null;
    const normalizedRouteId = routeId.includes(':') ? routeId : `HSL:${routeId}`;
    const cached = routeInfoCacheRef.current.get(normalizedRouteId);
    if (cached !== undefined) return cached || null;
    const inflight = routeLookupInFlightRef.current.get(normalizedRouteId);
    if (inflight) return inflight;

    const lookup = (async () => {
      try {
        const response = await fetch(DIGITRANSIT_GRAPHQL_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'digitransit-subscription-key': DIGITRANSIT_API_KEY
          },
          body: JSON.stringify({
            query: `
              query RouteInfo($id: String!) {
                route(id: $id) {
                  shortName
                  mode
                }
              }
            `,
            variables: { id: normalizedRouteId }
          })
        });
        if (!response.ok) {
          routeInfoCacheRef.current.set(normalizedRouteId, { shortName: '', mode: '' });
          return null;
        }
        const data = await response.json();
        const shortName = data?.data?.route?.shortName;
        const mode = data?.data?.route?.mode;
        const normalized = {
          shortName: typeof shortName === 'string' ? shortName.trim() : '',
          mode: typeof mode === 'string' ? mode.trim() : ''
        };
        routeInfoCacheRef.current.set(normalizedRouteId, normalized);
        return normalized.shortName || normalized.mode ? normalized : null;
      } catch {
        routeInfoCacheRef.current.set(normalizedRouteId, { shortName: '', mode: '' });
        return null;
      } finally {
        routeLookupInFlightRef.current.delete(normalizedRouteId);
      }
    })();

    routeLookupInFlightRef.current.set(normalizedRouteId, lookup);
    return lookup;
  }, []);

  const getTripRouteInfo = useCallback(async (tripId?: string | null) => {
    if (!tripId) return null;
    const cached = tripInfoCacheRef.current.get(tripId);
    if (cached !== undefined) return cached || null;
    const inflight = tripLookupInFlightRef.current.get(tripId);
    if (inflight) return inflight;

    const lookup = (async () => {
      try {
        const response = await fetch(DIGITRANSIT_GRAPHQL_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'digitransit-subscription-key': DIGITRANSIT_API_KEY
          },
          body: JSON.stringify({
            query: `
              query TripRouteInfo($id: String!) {
                trip(id: $id) {
                  route {
                    shortName
                    mode
                  }
                }
              }
            `,
            variables: { id: tripId }
          })
        });
        if (!response.ok) {
          tripInfoCacheRef.current.set(tripId, { shortName: '', mode: '' });
          return null;
        }
        const data = await response.json();
        const shortName = data?.data?.trip?.route?.shortName;
        const mode = data?.data?.trip?.route?.mode;
        const normalized = {
          shortName: typeof shortName === 'string' ? shortName.trim() : '',
          mode: typeof mode === 'string' ? mode.trim() : ''
        };
        tripInfoCacheRef.current.set(tripId, normalized);
        return normalized.shortName || normalized.mode ? normalized : null;
      } catch {
        tripInfoCacheRef.current.set(tripId, { shortName: '', mode: '' });
        return null;
      } finally {
        tripLookupInFlightRef.current.delete(tripId);
      }
    })();

    tripLookupInFlightRef.current.set(tripId, lookup);
    return lookup;
  }, []);


  const startTracking = useCallback(async () => {
    try {
      const { status } = await Location.requestForegroundPermissionsAsync();
      if (status !== 'granted') {
        setPermissionStatus('denied');
        setError('Location permission is required to track nearby aircraft.');
        return;
      }
      setPermissionStatus('granted');

      const current = await Location.getCurrentPositionAsync({
        accuracy: Location.Accuracy.Balanced,
      });
      setLocation(current);

      if (watchRef.current) {
        watchRef.current.remove();
        watchRef.current = null;
      }
      watchRef.current = await Location.watchPositionAsync(
        {
          accuracy: Location.Accuracy.Balanced,
          timeInterval: 15000,
          distanceInterval: 100,
        },
        (next) => setLocation(next)
      );
    } catch (err) {
      setError('Unable to access GPS. Please try again.');
    }
  }, []);

  useEffect(() => {
    void startTracking();

    return () => {
      if (watchRef.current) {
        watchRef.current.remove();
        watchRef.current = null;
      }
    };
  }, [startTracking]);

  useEffect(() => {
    const coords = useCustomCenter
      ? customCenter
      : location?.coords ?? (USE_DEMO_LOCATION ? DEMO_COORDS : null);
    if (!coords) return;

    const heading =
      !useCustomCenter &&
      typeof location?.coords?.heading === 'number' &&
      location.coords.heading >= 0
        ? location.coords.heading
        : null;

    lastCoordsRef.current = { latitude: coords.latitude, longitude: coords.longitude };
    lastHeadingRef.current = heading;

    const { latitude, longitude } = coords;
    if (webReady) {
      const source: 'gps' | 'demo' | 'custom' = useCustomCenter
        ? 'custom'
        : location?.coords
        ? 'gps'
        : 'demo';
      const customChanged =
        source === 'custom' &&
        (!lastCustomCenterRef.current ||
          lastCustomCenterRef.current.latitude !== latitude ||
          lastCustomCenterRef.current.longitude !== longitude);
      if (source === 'custom') {
        lastCustomCenterRef.current = { latitude, longitude };
      }
      const sourceChanged = centeredSourceRef.current !== source;
      const shouldRecenter = !hasCentered.current || sourceChanged || customChanged;
      if (shouldRecenter) {
        hasCentered.current = true;
        centeredSourceRef.current = source;
        const zoom =
          source === 'custom'
            ? typeof lastCustomZoomRef.current === 'number'
              ? lastCustomZoomRef.current
              : undefined
            : 16;
        webViewRef.current?.postMessage(
          JSON.stringify({ type: 'center', lat: latitude, lon: longitude, zoom })
        );
      }
      webViewRef.current?.postMessage(
        JSON.stringify({ type: 'me', lat: latitude, lon: longitude, heading })
      );
    }
  }, [location, useCustomCenter, customCenter, webReady]);

  useEffect(() => {
    const coords = useCustomCenter
      ? customCenter
      : location?.coords ?? (USE_DEMO_LOCATION ? DEMO_COORDS : null);
    if (permissionStatus === 'denied' && !USE_DEMO_LOCATION && !useCustomCenter) return;
    if (!coords) return;

    let isMounted = true;
    let timer: ReturnType<typeof setInterval> | null = null;

    const fetchAircraft = async () => {
      const { latitude, longitude } = coords;
      const radius = (radiusKm * NM_PER_KM).toFixed(1);
      const url = `${ADSB_BASE_URL}/${latitude}/${longitude}/${radius}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        const data = await response.json();
        let items: Aircraft[] = Array.isArray(data?.ac)
          ? data.ac
              .filter((item: Aircraft) => typeof item.lat === 'number' && typeof item.lon === 'number')
              .filter(
                (item: Aircraft) =>
                  distanceKm(latitude, longitude, item.lat as number, item.lon as number) <=
                  radiusKm
              )
              .map((item: Aircraft) => ({
                ...item,
                military: item.hex ? militaryHexSet.has(item.hex.toUpperCase()) : false,
              }))
          : [];
        
        // When Russian aircraft mode is on, only show Russian aircraft
        if (showRussianAircraft) {
          items = items.filter((item: Aircraft) => isRussianAircraft(item.hex));
        }
        
        if (!isMounted) return;

        latestAircraftRef.current = items;
        webViewRef.current?.postMessage(JSON.stringify({ type: 'aircraft', items }));
        if (enableProximity) {
          const center = useCustomCenter ? coords : lastCoordsRef.current ?? coords;
          if (center) sendProximityTarget(items, center);
        }
        setLastUpdated(new Date().toLocaleTimeString());
        setError(null);
      } catch (err) {
        if (!isMounted) return;
        setError('Failed to fetch aircraft data. Retrying...');
      } finally {
        if (isMounted) setLoading(false);
      }
    };

    fetchAircraft();
    timer = setInterval(fetchAircraft, POLL_MS);

    return () => {
      isMounted = false;
      if (timer) clearInterval(timer);
    };
  }, [permissionStatus, location, radiusKm, useCustomCenter, customCenter, enableProximity, showRussianAircraft, isRussianAircraft]);

  useEffect(() => {
    const timer = setInterval(() => {
      const selectedKey = selectedKeyRef.current;
      if (!selectedKey) return;
      const items = latestAircraftRef.current;
      const match = items.find((item) => getAircraftKey(item) === selectedKey) || null;
      if (match && !isSameAircraftSnapshot(selectedAircraft, match)) {
        setSelectedAircraft(match);
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [selectedAircraft]);

  useEffect(() => {
    if (!webReady) return;
    if (!showHslBuses) {
      webViewRef.current?.postMessage(JSON.stringify({ type: 'hslClear' }));
      setHslStatus('off');
      setHslLastMessage(new Date().toLocaleTimeString());
      return;
    }

    // Clear existing markers when filter changes
    webViewRef.current?.postMessage(JSON.stringify({ type: 'hslClear' }));

    // SURPRISE_FEATURE: Easter egg trigger (remove this block to disable)
    if (SURPRISE_ENABLED) {
      if (isSurpriseTrigger(hslLineFilter)) {
        webViewRef.current?.postMessage(JSON.stringify(getSurprisePayload(hslLineFilter)));
        setHslStatus('ok');
        return;
      } else {
        webViewRef.current?.postMessage(JSON.stringify({ type: 'hideSurprise' }));
      }
    }

    const coords = useCustomCenter
      ? customCenter
      : location?.coords ?? (USE_DEMO_LOCATION ? DEMO_COORDS : null);
    if (!coords) return;

    let isMounted = true;
    let timer: ReturnType<typeof setInterval> | null = null;

    const fetchBuses = async () => {
      try {
        setHslStatus('loading');
        setHslLastMessage(new Date().toLocaleTimeString());
        const response = await fetch('https://realtime.hsl.fi/realtime/vehicle-positions/v2/hsl');
        if (!response.ok) {
          throw new Error(`HSL feed error: ${response.status}`);
        }
        const buffer = await response.arrayBuffer();
        const feed = transit_realtime.FeedMessage.decode(new Uint8Array(buffer));
        const baseCoords = useCustomCenter ? coords : lastCoordsRef.current ?? coords;
        const { latitude, longitude } = baseCoords || {};
        if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) {
          webViewRef.current?.postMessage(JSON.stringify({ type: 'hslClear' }));
          setHslStatus('gps-required');
          return;
        }
        const rawVehicles = feed.entity
          .map((entity) => entity.vehicle)
          .filter(
            (vehicle): vehicle is transit_realtime.IVehiclePosition =>
              !!vehicle && !!vehicle.position
          );

        const filterDigits = hslLineFilter.trim().match(/\d+/)?.[0] || '';
        let total = 0;
        let within = 0;
        for (const vehicle of rawVehicles) {
          const lat = vehicle.position?.latitude;
          const lon = vehicle.position?.longitude;
          if (typeof lat !== 'number' || typeof lon !== 'number') continue;
          total += 1;
          const distance = distanceKm(latitude, longitude, lat, lon);
          if (hslRadiusEnabled && distance > hslRadiusKm) continue;
          within += 1;

          const routeId = vehicle.trip?.routeId || '';
          const tripId = vehicle.trip?.tripId || '';
          const rtShortName = (vehicle.trip as any)?.routeShortName as string | undefined;
          const rawRoute = rtShortName || routeId || tripId || '';
          const routeMatch = String(rawRoute).match(/[A-Za-z]*\d{1,3}[A-Za-z]?/);
          const route = routeMatch ? routeMatch[0] : String(rawRoute || 'HSL');
          const routeDigits = String(route).match(/\d+/)?.[0] || '';
          const id = vehicle.vehicle?.id || vehicle.vehicle?.label || 'HSL';
          const speed = vehicle.position?.speed
            ? Math.round(vehicle.position.speed * 3.6) + ' km/h'
            : null;
          const key = String(id) + '-' + String(routeId || tripId || route);

          // Always do async lookup to get correct mode (tram, metro, etc.)
          void (async () => {
            const routeInfo = await getRouteInfo(routeId);
            const tripInfo = await getTripRouteInfo(tripId);
            const shortName =
              rtShortName || routeInfo?.shortName || tripInfo?.shortName || '';
            const mode = routeInfo?.mode || tripInfo?.mode || '';
            const finalMode = mode ? String(mode).toUpperCase() : 'BUS';
            if (
              (finalMode === 'TRAM' && !showHslTram) ||
              (finalMode === 'SUBWAY' && !showHslMetro) ||
              (finalMode === 'RAIL' && !showHslRail) ||
              (finalMode === 'FERRY' && !showHslFerry) ||
              (finalMode === 'BUS' && !showHslBus)
            ) {
              return;
            }
            const raw = shortName || routeId || tripId || '';
            const match = String(raw).match(/[A-Za-z]*\d{1,3}[A-Za-z]?/);
            const finalRoute = match ? match[0] : String(raw || 'HSL');
            if (filterDigits) {
              const finalRouteDigits = String(finalRoute).match(/\d+/)?.[0] || '';
              if (!finalRouteDigits || finalRouteDigits !== filterDigits) return;
            }
            const asyncDistance =
              coords && typeof lat === 'number' && typeof lon === 'number'
                ? distanceKm(coords.latitude, coords.longitude, lat, lon)
                : null;
            if (
              hslRadiusEnabled &&
              typeof asyncDistance === 'number' &&
              asyncDistance > hslRadiusKm
            ) {
              return;
            }
            const finalLabel = [
              finalRoute ? `<span class="line-text">Line ${finalRoute}</span>` : null,
              id ? `ID ${id}` : null,
              speed,
            ]
              .filter((x) => x)
              .join('<br/>');
            webViewRef.current?.postMessage(
              JSON.stringify({
                type: 'hslBus',
                bus: {
                  key,
                  lat,
                  lon,
                  label: finalLabel,
                  mode: finalMode,
                },
              })
            );
          })();
        }

        if (!isMounted) return;
        setHslStatus('ok');
        setHslLastMessage(new Date().toLocaleTimeString());
      } catch (err) {
        if (!isMounted) return;
        setHslStatus('error');
        setHslLastMessage(new Date().toLocaleTimeString());
      }
    };

    fetchBuses();
    timer = setInterval(fetchBuses, 5000);

    return () => {
      isMounted = false;
      if (timer) clearInterval(timer);
    };
  }, [
    showHslBuses,
    showHslBus,
    showHslTram,
    showHslMetro,
    showHslRail,
    showHslFerry,
    hslRadiusEnabled,
    hslRadiusKm,
    hslLineFilter,
    webReady,
    location,
    useCustomCenter,
    customCenter,
    radiusKm,
  ]);

  useEffect(() => {
    if (!webReady) return;
    webViewRef.current?.postMessage(JSON.stringify({ type: 'trace', enabled: enableTracing }));
  }, [enableTracing, webReady]);

  useEffect(() => {
    if (!webReady) return;
    webViewRef.current?.postMessage(JSON.stringify({ type: 'proximity', enabled: enableProximity }));
  }, [enableProximity, webReady]);

  useEffect(() => {
    if (!webReady) return;
    webViewRef.current?.postMessage(JSON.stringify({ type: 'fir', enabled: showFirAirspaces }));
  }, [showFirAirspaces, webReady]);

  // Russian aircraft tracks - fetch and display when toggle is enabled
  useEffect(() => {
    if (!webReady) return;
    
    if (!showRussianAircraft) {
      // Clear tracks when disabled
      webViewRef.current?.postMessage(JSON.stringify({ type: 'russianTracksEnabled', enabled: false }));
      return;
    }

    // Enable Russian mode for red icons
    webViewRef.current?.postMessage(JSON.stringify({ type: 'russianTracksEnabled', enabled: true }));

    // Get current center coordinates
    const center = useCustomCenter
      ? customCenter
      : lastCoordsRef.current ?? (location?.coords ?? (USE_DEMO_LOCATION ? DEMO_COORDS : null));

    // Fetch tracks and send to webview
    const fetchTracks = async () => {
      try {
        // Fetch ALL Russian tracks without radius filter to see entire corridor
        const tracks = await fetchRussianTracks();
        webViewRef.current?.postMessage(JSON.stringify({ type: 'russianTracks', tracks }));
      } catch (error) {
        console.error('Error fetching Russian tracks:', error);
      }
    };

    fetchTracks();

    // Refresh tracks every 60 seconds while enabled
    const interval = setInterval(fetchTracks, 60000);
    return () => clearInterval(interval);
  }, [showRussianAircraft, webReady]);

  useEffect(() => {
    if (!webReady || !enableProximity) return;
    const center = useCustomCenter
      ? customCenter
      : lastCoordsRef.current ?? (location?.coords ?? (USE_DEMO_LOCATION ? DEMO_COORDS : null));
    if (!center) return;
    sendProximityTarget(latestAircraftRef.current, center);
  }, [enableProximity, selectedAircraft, webReady, location, useCustomCenter, customCenter]);

  return (
    <View style={styles.container}>
      <WebView
        ref={webViewRef}
        style={styles.webview}
        originWhitelist={['*']}
        source={{ html }}
        javaScriptEnabled
        domStorageEnabled
        mixedContentMode="always"
        allowUniversalAccessFromFileURLs
        allowFileAccess
        cacheEnabled={false}
        onMessage={(event) => {
          try {
            const data = JSON.parse(event.nativeEvent.data);
            if (data?.type === 'ready') {
              setLoading(false);
              setWebReady(true);
              // Ensure webview gets current HSL toggle state on load.
              webViewRef.current?.postMessage(
                JSON.stringify({ type: 'hslBuses', enabled: showHslBuses })
              );
              webViewRef.current?.postMessage(
                JSON.stringify({ type: 'trace', enabled: enableTracing })
              );
              webViewRef.current?.postMessage(
                JSON.stringify({ type: 'proximity', enabled: enableProximity })
              );
              const coords = useCustomCenter ? customCenter : lastCoordsRef.current;
              if (coords) {
                const zoom = useCustomCenter
                  ? typeof lastCustomZoomRef.current === 'number'
                    ? lastCustomZoomRef.current
                    : 16
                  : 16;
                webViewRef.current?.postMessage(
                  JSON.stringify({ type: 'center', lat: coords.latitude, lon: coords.longitude, zoom })
                );
                webViewRef.current?.postMessage(
                  JSON.stringify({
                    type: 'me',
                    lat: coords.latitude,
                    lon: coords.longitude,
                    heading: useCustomCenter ? null : lastHeadingRef.current
                  })
                );
                hasCentered.current = true;
              }
            }
            if (data?.type === 'jsError') {
              setWebError(`Map error: ${data.message}`);
            }
            if (data?.type === 'select') {
              setSelectedAircraft(data.item || null);
            }
            if (data?.type === 'mapClick') {
              if (
                useCustomCenter &&
                typeof data.lat === 'number' &&
                typeof data.lon === 'number'
              ) {
                setCustomCenter({ latitude: data.lat, longitude: data.lon });
                if (Number.isFinite(data.zoom)) {
                  lastCustomZoomRef.current = data.zoom;
                }
                if (webReady) {
                  const zoom = Number.isFinite(data.zoom) ? data.zoom : undefined;
                  webViewRef.current?.postMessage(
                    JSON.stringify({ type: 'center', lat: data.lat, lon: data.lon, zoom })
                  );
                }
                setError(null);
              }
            }
            if (data?.type === 'recenter') {
              const coords = useCustomCenter ? customCenter : lastCoordsRef.current;
              if (coords) {
                const zoom = useCustomCenter
                  ? typeof lastCustomZoomRef.current === 'number'
                    ? lastCustomZoomRef.current
                    : undefined
                  : 16;
                webViewRef.current?.postMessage(
                  JSON.stringify({
                    type: 'center',
                    lat: coords.latitude,
                    lon: coords.longitude,
                    zoom,
                  })
                );
              }
            }
            if (data?.type === 'hslStatus') {
              setHslStatus(data.status || null);
              setHslLastMessage(new Date().toLocaleTimeString());
            }
          } catch (err) {
            // ignore non-JSON messages
          }
        }}
        onLoadEnd={() => setLoading(false)}
        onError={(event) => {
          setWebError(event.nativeEvent.description || 'WebView failed to load.');
        }}
        onHttpError={(event) => {
          setWebError(`WebView HTTP error: ${event.nativeEvent.statusCode}`);
        }}
      />

      <View style={[styles.overlay, headerCollapsed ? styles.overlayCollapsed : null]}>
        {!headerCollapsed ? (
          <View style={styles.overlayContent}>
            <View style={styles.titleRow}>
              <Pressable
                onPress={() => setHeaderCollapsed(true)}
                hitSlop={8}
                style={styles.titleCollapse}
              >
                <Text style={styles.collapseArrow}>‹</Text>
              </Pressable>
              <Text style={styles.title}>Tracker</Text>
            </View>
            <View style={styles.searchRow}>
              <TextInput
                value={hslLineFilter}
                onChangeText={setHslLineFilter}
                placeholder="Add a number"
                placeholderTextColor="#9aa4b2"
                keyboardType="number-pad"
                style={styles.searchInput}
              />
              <Pressable
                onPress={() => setHslLineFilter('')}
                style={styles.searchClear}
                hitSlop={6}
              >
                <Text style={styles.searchClearText}>×</Text>
              </Pressable>
            </View>
            {error &&
            !(useCustomCenter &&
              (error === 'Location permission is required to track nearby aircraft.' ||
                error === 'Unable to access GPS. Please try again.')) ? (
              <Text style={styles.error}>{error}</Text>
            ) : null}
            {webError ? <Text style={styles.error}>{webError}</Text> : null}
            {permissionStatus === 'denied' && !USE_DEMO_LOCATION && !useCustomCenter ? (
              <Text style={styles.error}>Enable GPS permission in settings to continue.</Text>
            ) : null}
          </View>
        ) : (
          <Pressable
            onPress={() => setHeaderCollapsed(false)}
            hitSlop={8}
            style={[styles.overlayHandle, headerCollapsed ? styles.overlayHandleCollapsed : null]}
          >
            <Text style={styles.collapseArrow}>›</Text>
          </Pressable>
        )}
      </View>

      {selectedAircraft ? (
        <View style={styles.bottomSheet}>
          <View style={styles.sheetHeader}>
            <Text style={styles.sheetTitle}>Selected Aircraft</Text>
            <Pressable onPress={() => setSelectedAircraft(null)} hitSlop={8}>
              <Text style={styles.sheetClose}>×</Text>
            </Pressable>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Flight</Text>
            <Text style={styles.sheetValue}>
              {selectedAircraft?.flight?.trim() || selectedAircraft?.hex?.toUpperCase() || '—'}
            </Text>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Airline (guess)</Text>
            <Text style={styles.sheetValue}>
              {getAirlineGuess(selectedAircraft?.flight)}
            </Text>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Altitude</Text>
            <Text style={styles.sheetValue}>
              {selectedAircraft?.alt_baro ? `${Math.round(selectedAircraft.alt_baro)} ft` : '—'}
            </Text>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Ground Speed</Text>
            <Text style={styles.sheetValue}>
              {selectedAircraft?.gs ? `${Math.round(selectedAircraft.gs)} kt` : '—'}
            </Text>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Heading</Text>
            <Text style={styles.sheetValue}>
              {selectedAircraft?.track ? `${Math.round(selectedAircraft.track)}°` : '—'}
            </Text>
          </View>
          <View style={styles.sheetRow}>
            <Text style={styles.sheetLabel}>Aircraft</Text>
            <Text style={styles.sheetValue}>
              {selectedAircraft?.desc ? selectedAircraft.desc : '—'}
            </Text>
          </View>
          <Pressable
            onPress={() => setDetailsExpanded((prev) => !prev)}
            style={styles.expandButton}
          >
            <Text style={styles.expandText}>
              {detailsExpanded ? 'Hide details ▲' : 'Show all details ▼'}
            </Text>
          </Pressable>
          {detailsExpanded ? (
            <ScrollView style={styles.sheetScroll}>
              {Object.entries(selectedAircraft)
                .filter(([, value]) => value !== undefined && value !== null && value !== '')
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([key, value]) => (
                  <View key={key} style={styles.sheetRow}>
                    <Text style={styles.sheetLabel}>{key}</Text>
                    <Text style={styles.sheetValue}>{formatValue(value)}</Text>
                  </View>
                ))}
            </ScrollView>
          ) : null}
        </View>
      ) : (
        <View style={styles.sheetHintOnly}>
          <Text style={styles.sheetHint}>Tap a plane icon to view details.</Text>
        </View>
      )}

      {loading ? (
        <View style={styles.loading}>
          <ActivityIndicator size="large" color="#f7c948" />
          <Text style={styles.loadingText}>Loading map…</Text>
        </View>
      ) : null}

      {permissionStatus === 'denied' && !USE_DEMO_LOCATION ? (
        <View style={styles.permission}>
          <Text style={styles.permissionText}>GPS permission is required.</Text>
          <Pressable onPress={() => startTracking()}>
            <Text style={styles.permissionButton}>Request Permission</Text>
          </Pressable>
        </View>
      ) : null}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#0e1116',
  },
  webview: {
    flex: 1,
    backgroundColor: '#0e1116',
  },
  overlay: {
    position: 'absolute',
    top: 46,
    left: 16,
    width: 180,
    padding: 12,
    borderRadius: 18,
    backgroundColor: 'rgba(10, 12, 18, 0.62)',
    borderWidth: 1,
    borderColor: 'rgba(120, 130, 150, 0.35)',
    shadowColor: '#000',
    shadowOpacity: 0.35,
    shadowRadius: 12,
    shadowOffset: { width: 0, height: 8 },
    elevation: 6,
  },
  overlayCollapsed: {
    width: 0,
    padding: 0,
    borderWidth: 0,
    backgroundColor: 'transparent',
    shadowOpacity: 0,
    elevation: 0,
  },
  overlayHandle: {
    position: 'absolute',
    right: -22,
    top: 12,
    width: 22,
    height: 38,
    borderTopRightRadius: 10,
    borderBottomRightRadius: 10,
    backgroundColor: 'rgba(10, 12, 18, 0.65)',
    borderWidth: 1,
    borderColor: 'rgba(120, 130, 150, 0.35)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  overlayHandleCollapsed: {
    left: 0,
    right: undefined,
  },
  overlayContent: {
    gap: 6,
  },
  titleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  titleCollapse: {
    width: 24,
    height: 24,
    borderRadius: 12,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.06)',
  },
  collapseArrow: {
    color: '#f7c948',
    fontSize: 20,
    fontWeight: '800',
    lineHeight: 20,
  },
  title: {
    color: '#f7c948',
    fontSize: 20,
    fontWeight: '800',
    letterSpacing: 0.4,
  },
  searchRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginTop: 8,
    marginBottom: 2,
  },
  searchInput: {
    flex: 1,
    backgroundColor: 'rgba(20, 23, 30, 0.9)',
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.12)',
    borderRadius: 12,
    paddingHorizontal: 12,
    paddingVertical: 7,
    color: '#f6d365',
    fontSize: 14,
  },
  searchInputInline: {
    flex: 1,
    backgroundColor: 'rgba(20, 23, 30, 0.9)',
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.12)',
    borderRadius: 12,
    paddingHorizontal: 12,
    paddingVertical: 7,
    marginLeft: 12,
    color: '#f6d365',
    fontSize: 14,
  },
  searchClear: {
    width: 28,
    height: 28,
    borderRadius: 14,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.12)',
  },
  searchClearText: {
    color: '#f5f7fb',
    fontSize: 18,
    lineHeight: 18,
  },
  subtitle: {
    color: '#e9ecef',
    marginTop: 4,
    fontSize: 13,
  },
  meta: {
    color: '#9aa4b2',
    marginTop: 6,
    fontSize: 12,
  },
  error: {
    color: '#ff6b6b',
    marginTop: 6,
    fontSize: 12,
  },
  loading: {
    position: 'absolute',
    alignSelf: 'center',
    top: '45%',
    padding: 16,
    borderRadius: 14,
    backgroundColor: 'rgba(14, 17, 22, 0.9)',
    alignItems: 'center',
  },
  loadingText: {
    color: '#f7c948',
    marginTop: 8,
  },
  chipRow: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginTop: 8,
    gap: 6,
  },
  chip: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    backgroundColor: 'rgba(247, 201, 72, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(247, 201, 72, 0.35)',
    color: '#f7c948',
    fontSize: 11,
    fontWeight: '600',
  },
  bottomSheet: {
    position: 'absolute',
    left: 16,
    right: 56,
    bottom: 22,
    padding: 16,
    borderRadius: 18,
    backgroundColor: 'rgba(12, 15, 20, 0.9)',
    borderWidth: 1,
    borderColor: 'rgba(80, 90, 110, 0.5)',
    maxHeight: '45%',
  },
  sheetHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    marginBottom: 10,
  },
  sheetTitle: {
    color: '#f7c948',
    fontSize: 16,
    fontWeight: '700',
  },
  sheetClose: {
    color: '#9aa4b2',
    fontSize: 22,
    fontWeight: '700',
    lineHeight: 22,
  },
  sheetRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 6,
  },
  sheetLabel: {
    color: '#9aa4b2',
    fontSize: 12,
  },
  sheetValue: {
    color: '#e9ecef',
    fontSize: 12,
    fontWeight: '600',
  },
  sheetHint: {
    color: '#7f8a99',
    fontSize: 11,
    marginTop: 8,
  },
  sheetScroll: {
    marginTop: 6,
    marginBottom: 4,
  },
  expandButton: {
    marginTop: 6,
    paddingVertical: 6,
    alignSelf: 'flex-start',
  },
  expandText: {
    color: '#f7c948',
    fontSize: 12,
    fontWeight: '600',
  },
  sheetHintOnly: {
    position: 'absolute',
    left: 16,
    right: 16,
    bottom: 22,
    paddingVertical: 10,
    alignItems: 'center',
  },
  permission: {
    position: 'absolute',
    bottom: 24,
    left: 16,
    right: 16,
    padding: 16,
    borderRadius: 16,
    backgroundColor: 'rgba(255, 107, 107, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(255, 107, 107, 0.6)',
    alignItems: 'center',
  },
  permissionText: {
    color: '#ff6b6b',
    marginBottom: 10,
    fontWeight: '600',
  },
  permissionButton: {
    color: '#f7c948',
    fontWeight: '700',
  },
});
